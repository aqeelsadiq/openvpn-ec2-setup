name: OpenVPN User and Group Management via SSH

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - create-users
          - create-groups
          - create-users-and-groups
          - assign-users-to-groups
          - list-groups
        default: 'create-users'
      users:
        description: 'Comma-separated VPN usernames to create (e.g., alice,bob,charlie)'
        required: false
        default: ''
      groups:
        description: 'Comma-separated VPN group names to create (e.g., engineering,sales,admin)'
        required: false
        default: ''
      user_group_mapping:
        description: 'User-to-group mapping (format: user1:group1,user2:group2,user3:group1)'
        required: false
        default: ''
      users_with_groups:
        description: 'Create users directly in groups (format: user1:group1,user2:group2)'
        required: false
        default: ''

jobs:
  manage-vpn:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repo
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Configure AWS CLI
      - name: Configure AWS CLI
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 3Ô∏è‚É£ Validate inputs based on action
      - name: Validate inputs
        id: validate
        run: |
          ACTION="${{ github.event.inputs.action }}"
          USERS="${{ github.event.inputs.users }}"
          GROUPS="${{ github.event.inputs.groups }}"
          MAPPING="${{ github.event.inputs.user_group_mapping }}"
          USERS_WITH_GROUPS="${{ github.event.inputs.users_with_groups }}"

          echo "action=$ACTION" >> $GITHUB_OUTPUT

          case $ACTION in
            create-users)
              if [ -z "$USERS" ]; then
                echo "::error::Users input is required for create-users action"
                exit 1
              fi
              ;;
            create-groups)
              if [ -z "$GROUPS" ]; then
                echo "::error::Groups input is required for create-groups action"
                exit 1
              fi
              ;;
            create-users-and-groups)
              if [ -z "$USERS" ] && [ -z "$GROUPS" ] && [ -z "$USERS_WITH_GROUPS" ]; then
                echo "::error::At least one of users, groups, or users_with_groups is required"
                exit 1
              fi
              ;;
            assign-users-to-groups)
              if [ -z "$MAPPING" ]; then
                echo "::error::user_group_mapping is required for assign-users-to-groups action"
                exit 1
              fi
              ;;
            list-groups)
              # No validation needed
              ;;
          esac

      # 4Ô∏è‚É£ Parse inputs
      - name: Parse inputs
        id: parse_inputs
        run: |
          # Parse users
          if [ -n "${{ github.event.inputs.users }}" ]; then
            IFS=',' read -ra USERS <<< "${{ github.event.inputs.users }}"
            echo "users=${USERS[*]}" >> $GITHUB_OUTPUT
            echo "has_users=true" >> $GITHUB_OUTPUT
          else
            echo "users=" >> $GITHUB_OUTPUT
            echo "has_users=false" >> $GITHUB_OUTPUT
          fi

          # Parse groups
          if [ -n "${{ github.event.inputs.groups }}" ]; then
            IFS=',' read -ra GROUPS <<< "${{ github.event.inputs.groups }}"
            echo "groups=${GROUPS[*]}" >> $GITHUB_OUTPUT
            echo "has_groups=true" >> $GITHUB_OUTPUT
          else
            echo "groups=" >> $GITHUB_OUTPUT
            echo "has_groups=false" >> $GITHUB_OUTPUT
          fi

          # Parse user-group mapping
          if [ -n "${{ github.event.inputs.user_group_mapping }}" ]; then
            echo "user_group_mapping=${{ github.event.inputs.user_group_mapping }}" >> $GITHUB_OUTPUT
            echo "has_mapping=true" >> $GITHUB_OUTPUT
          else
            echo "user_group_mapping=" >> $GITHUB_OUTPUT
            echo "has_mapping=false" >> $GITHUB_OUTPUT
          fi

          # Parse users with groups
          if [ -n "${{ github.event.inputs.users_with_groups }}" ]; then
            echo "users_with_groups=${{ github.event.inputs.users_with_groups }}" >> $GITHUB_OUTPUT
            echo "has_users_with_groups=true" >> $GITHUB_OUTPUT
          else
            echo "users_with_groups=" >> $GITHUB_OUTPUT
            echo "has_users_with_groups=false" >> $GITHUB_OUTPUT
          fi

      # 5Ô∏è‚É£ Get EC2 instance public IPs from ASG
      - name: Get EC2 public IPs from ASG
        id: get_ips
        run: |
          ASG_NAME="dev-rhizome-asg"  
          INSTANCE_IDS=$(aws autoscaling describe-auto-scaling-groups \
            --auto-scaling-group-names $ASG_NAME \
            --query "AutoScalingGroups[0].Instances[?LifecycleState=='InService'].InstanceId" \
            --output text)
          
          if [ -z "$INSTANCE_IDS" ]; then
            echo "::error::No running instances found in ASG: $ASG_NAME"
            exit 1
          fi
          
          echo "Instance IDs: $INSTANCE_IDS"

          PUBLIC_IPS=""
          for ID in $INSTANCE_IDS; do
            IP=$(aws ec2 describe-instances \
              --instance-ids $ID \
              --query "Reservations[0].Instances[0].PublicIpAddress" \
              --output text)
            PUBLIC_IPS="$PUBLIC_IPS $IP"
          done

          echo "ips=$PUBLIC_IPS" >> $GITHUB_OUTPUT
          echo "Public IPs: $PUBLIC_IPS"

      # 6Ô∏è‚É£ Create VPN groups
      - name: Create VPN groups
        if: |
          (steps.validate.outputs.action == 'create-groups' || 
           steps.validate.outputs.action == 'create-users-and-groups') &&
          steps.parse_inputs.outputs.has_groups == 'true'
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ steps.get_ips.outputs.ips }}
          username: ubuntu
          key: ${{ secrets.OPENVPN_SSH_KEY }}
          script: |
            echo "=== Creating VPN Groups ==="
            for GROUP in ${{ steps.parse_inputs.outputs.groups }}; do
              echo "Creating VPN group: $GROUP"
              sudo /usr/local/bin/add-vpn-group.sh "$GROUP"
            done
            echo "=== Groups Created Successfully ==="

      # 7Ô∏è‚É£ Create VPN users (without groups)
      - name: Create VPN users
        if: |
          (steps.validate.outputs.action == 'create-users' || 
           steps.validate.outputs.action == 'create-users-and-groups') &&
          steps.parse_inputs.outputs.has_users == 'true'
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ steps.get_ips.outputs.ips }}
          username: ubuntu
          key: ${{ secrets.OPENVPN_SSH_KEY }}
          script: |
            echo "=== Creating VPN Users ==="
            for USER in ${{ steps.parse_inputs.outputs.users }}; do
              echo "Creating VPN user: $USER"
              sudo /usr/local/bin/add-vpn-user.sh "$USER"
            done
            echo "=== Users Created Successfully ==="

      # 8Ô∏è‚É£ Create users with groups directly
      - name: Create users with groups
        if: |
          steps.validate.outputs.action == 'create-users-and-groups' &&
          steps.parse_inputs.outputs.has_users_with_groups == 'true'
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ steps.get_ips.outputs.ips }}
          username: ubuntu
          key: ${{ secrets.OPENVPN_SSH_KEY }}
          script: |
            echo "=== Creating Users with Group Assignment ==="
            MAPPING="${{ steps.parse_inputs.outputs.users_with_groups }}"
            IFS=',' read -ra PAIRS <<< "$MAPPING"
            for PAIR in "${PAIRS[@]}"; do
              IFS=':' read -ra ITEM <<< "$PAIR"
              USER="${ITEM[0]}"
              GROUP="${ITEM[1]}"
              echo "Creating user $USER in group $GROUP"
              sudo /usr/local/bin/add-vpn-user.sh "$USER" "$GROUP"
            done
            echo "=== Users Created and Assigned Successfully ==="

      # 9Ô∏è‚É£ Assign existing users to groups
      - name: Assign users to groups
        if: |
          (steps.validate.outputs.action == 'assign-users-to-groups' ||
           steps.validate.outputs.action == 'create-users-and-groups') &&
          steps.parse_inputs.outputs.has_mapping == 'true'
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ steps.get_ips.outputs.ips }}
          username: ubuntu
          key: ${{ secrets.OPENVPN_SSH_KEY }}
          script: |
            echo "=== Assigning Users to Groups ==="
            MAPPING="${{ steps.parse_inputs.outputs.user_group_mapping }}"
            IFS=',' read -ra PAIRS <<< "$MAPPING"
            for PAIR in "${PAIRS[@]}"; do
              IFS=':' read -ra ITEM <<< "$PAIR"
              USER="${ITEM[0]}"
              GROUP="${ITEM[1]}"
              echo "Assigning user $USER to group $GROUP"
              sudo /usr/local/bin/assign-user-to-group.sh "$USER" "$GROUP"
            done
            echo "=== Users Assigned Successfully ==="

      # üîü List all groups
      - name: List VPN groups
        if: steps.validate.outputs.action == 'list-groups'
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ steps.get_ips.outputs.ips }}
          username: ubuntu
          key: ${{ secrets.OPENVPN_SSH_KEY }}
          script: |
            echo "=== Listing All VPN Groups ==="
            sudo /usr/local/bin/list-vpn-groups.sh
            echo ""
            echo "=== All VPN Users ==="
            ls -1 /etc/openvpn/clients/*.ovpn 2>/dev/null | xargs -n1 basename | sed 's/.ovpn$//' || echo "No users found"

      # 1Ô∏è‚É£1Ô∏è‚É£ Summary
      - name: Workflow Summary
        if: always()
        run: |
          echo "=== Workflow Execution Summary ===" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** ${{ github.event.inputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.parse_inputs.outputs.has_groups }}" == "true" ]; then
            echo "**Groups Created:** ${{ github.event.inputs.groups }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.parse_inputs.outputs.has_users }}" == "true" ]; then
            echo "**Users Created:** ${{ github.event.inputs.users }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.parse_inputs.outputs.has_users_with_groups }}" == "true" ]; then
            echo "**Users with Groups:** ${{ github.event.inputs.users_with_groups }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.parse_inputs.outputs.has_mapping }}" == "true" ]; then
            echo "**User Assignments:** ${{ github.event.inputs.user_group_mapping }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Target IPs:** ${{ steps.get_ips.outputs.ips }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ **Status:** Workflow completed successfully!" >> $GITHUB_STEP_SUMMARY