name: OpenVPN User & Group Management via SSH

on:
  workflow_dispatch:
    inputs:
      users:
        description: 'Comma-separated VPN usernames'
        required: true
        default: 'alice'
      groups:
        description: 'Comma-separated Linux groups'
        required: true
        default: 'vpn-users'

jobs:
  manage-vpn-access:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repo
      - name: Checkout repo
        uses: actions/checkout@v3

      # 2️⃣ Configure AWS CLI
      - name: Configure AWS CLI
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 3️⃣ Parse users
      - name: Parse users
        id: parse_users
        run: |
          IFS=',' read -ra USERS <<< "${{ github.event.inputs.users }}"
          echo "users=${USERS[*]}" >> $GITHUB_OUTPUT

      # 4️⃣ Parse groups
      - name: Parse groups
        id: parse_groups
        run: |
          IFS=',' read -ra GROUPS <<< "${{ github.event.inputs.groups }}"
          echo "groups=${GROUPS[*]}" >> $GITHUB_OUTPUT

      # 5️⃣ Get EC2 Public IPs from ASG
      - name: Get EC2 public IPs
        id: get_ips
        run: |
          ASG_NAME="dev-demo-asg"

          INSTANCE_IDS=$(aws autoscaling describe-auto-scaling-groups \
            --auto-scaling-group-names $ASG_NAME \
            --query "AutoScalingGroups[0].Instances[].InstanceId" \
            --output text)

          PUBLIC_IPS=""
          for ID in $INSTANCE_IDS; do
            IP=$(aws ec2 describe-instances \
              --instance-ids $ID \
              --query "Reservations[0].Instances[0].PublicIpAddress" \
              --output text)
            PUBLIC_IPS="$PUBLIC_IPS $IP"
          done

          echo "ips=$PUBLIC_IPS" >> $GITHUB_OUTPUT

      # 6️⃣ Create groups, users & assign groups via SSH
      - name: Manage users & groups
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ steps.get_ips.outputs.ips }}
          username: ubuntu
          key: ${{ secrets.OPENVPN_SSH_KEY }}
          script: |
            USERS="${{ steps.parse_users.outputs.users }}"
            GROUPS="${{ steps.parse_groups.outputs.groups }}"

            # Create groups if not exist
            for GROUP in $GROUPS; do
              if getent group "$GROUP" >/dev/null; then
                echo "Group $GROUP already exists"
              else
                echo "Creating group $GROUP"
                sudo groupadd "$GROUP"
              fi
            done

            # Create users and add to groups
            for USER in $USERS; do
              if id "$USER" >/dev/null 2>&1; then
                echo "User $USER already exists"
              else
                echo "Creating user $USER"
                sudo useradd -m "$USER"
              fi

              for GROUP in $GROUPS; do
                echo "Adding $USER to group $GROUP"
                sudo usermod -aG "$GROUP" "$USER"
              done

              # Create OpenVPN user
              echo "Creating OpenVPN user for $USER"
              sudo /usr/local/bin/add-vpn-user.sh "$USER"
            done
