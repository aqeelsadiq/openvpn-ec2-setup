# name: OpenVPN User & Group Management via SSH

# on:
#   workflow_dispatch:
#     inputs:
#       users:
#         description: 'Comma-separated VPN usernames'
#         required: true
#         default: 'alice'
#       groups:
#         description: 'Comma-separated Linux groups'
#         required: true
#         default: 'vpn-users'

# jobs:
#   manage-vpn-access:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout repo
#         uses: actions/checkout@v3

#       - name: Configure AWS CLI
#         uses: aws-actions/configure-aws-credentials@v2
#         with:
#           aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
#           aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#           aws-region: ${{ secrets.AWS_REGION }}

#       - name: Parse users
#         id: parse_users
#         run: |
#           echo "users=${{ github.event.inputs.users }}" >> "$GITHUB_OUTPUT"
        
        

#       - name: Parse groups
#         id: parse_groups
#         run: |
#           echo "groups=${{ github.event.inputs.groups }}" >> "$GITHUB_OUTPUT"
        

#       - name: Get EC2 public IPs
#         id: get_ips
#         run: |
#           ASG_NAME="dev-demo-asg"

#           INSTANCE_IDS=$(aws autoscaling describe-auto-scaling-groups \
#             --auto-scaling-group-names $ASG_NAME \
#             --query "AutoScalingGroups[0].Instances[].InstanceId" \
#             --output text)

#           PUBLIC_IPS=""
#           for ID in $INSTANCE_IDS; do
#             IP=$(aws ec2 describe-instances \
#               --instance-ids $ID \
#               --query "Reservations[0].Instances[0].PublicIpAddress" \
#               --output text)
#             PUBLIC_IPS="$PUBLIC_IPS $IP"
#           done

#           echo "ips=$PUBLIC_IPS" >> $GITHUB_OUTPUT

#       - name: Manage users & groups
#         uses: appleboy/ssh-action@v0.1.8
#         with:
#           host: ${{ steps.get_ips.outputs.ips }}
#           username: ubuntu
#           key: ${{ secrets.OPENVPN_SSH_KEY }}
#           script: |
#             USERS="${{ steps.parse_users.outputs.users }}"
#             GROUPS="${{ steps.parse_groups.outputs.groups }}"

#             # Create groups if not exist
#             for GROUP in $GROUPS; do
#               if getent group "$GROUP" >/dev/null; then
#                 echo "Group $GROUP already exists"
#               else
#                 echo "Creating group $GROUP"
#                 sudo groupadd "$GROUP"
#               fi
#             done

#             # Create users and add to groups
#             for USER in $USERS; do
#               if id "$USER" >/dev/null 2>&1; then
#                 echo "User $USER already exists"
#               else
#                 echo "Creating user $USER"
#                 sudo useradd -m "$USER"
#               fi

#               for GROUP in $GROUPS; do
#                 echo "Adding $USER to group $GROUP"
#                 sudo usermod -aG "$GROUP" "$USER"
#               done

#               # Create OpenVPN user
#               echo "Creating OpenVPN user for $USER"
#               sudo /usr/local/bin/add-vpn-user.sh "$USER"
#             done
name: OpenVPN User & Group Management (EC2)

on:
  workflow_dispatch:
    inputs:
      username:
        description: "VPN username"
        required: true
      action:
        description: "Action to perform"
        required: true
        type: choice
        options:
          - create
          - delete
      groups:
        description: "Comma-separated OpenVPN groups"
        required: false
        default: "DEV-VPN-USERS"

env:
  AWS_REGION: us-east-1
  ASG_NAME: dev-demo-asg

jobs:
  manage-openvpn:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Validate inputs
        run: |
          if [[ -z "${{ inputs.username }}" ]]; then
            echo "Username is required"
            exit 1
          fi

      - name: Get EC2 Public IPs
        id: ec2
        run: |
          IDS=$(aws autoscaling describe-auto-scaling-groups \
            --auto-scaling-group-names "${ASG_NAME}" \
            --query "AutoScalingGroups[0].Instances[].InstanceId" \
            --output text)

          IPS=""
          for ID in $IDS; do
            IP=$(aws ec2 describe-instances \
              --instance-ids "$ID" \
              --query "Reservations[0].Instances[0].PublicIpAddress" \
              --output text)
            IPS="$IPS $IP"
          done

          echo "ips=$IPS" >> $GITHUB_OUTPUT

      - name: Manage OpenVPN users
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ steps.ec2.outputs.ips }}
          username: ubuntu
          key: ${{ secrets.OPENVPN_SSH_KEY }}
          script: |
            set -e

            USER="${{ inputs.username }}"
            ACTION="${{ inputs.action }}"
            GROUPS="${{ inputs.groups }}"

            log() { echo "[INFO] $1"; }

            if [[ "$ACTION" == "create" ]]; then
              log "Creating VPN user: $USER"

              if ! id "$USER" &>/dev/null; then
                sudo useradd -m "$USER"
              else
                log "User already exists"
              fi

              for GROUP in $(echo "$GROUPS" | tr ',' ' '); do
                if ! getent group "$GROUP" >/dev/null; then
                  log "Creating VPN group: $GROUP"
                  sudo groupadd "$GROUP"
                fi
                sudo usermod -aG "$GROUP" "$USER"
              done

              log "Creating OpenVPN credentials"
              sudo /usr/local/bin/add-vpn-user.sh "$USER"

            elif [[ "$ACTION" == "delete" ]]; then
              log "Deleting VPN user: $USER"

              sudo /usr/local/bin/revoke-vpn-user.sh "$USER" || true
              sudo userdel -r "$USER" || true
            fi

            log "Operation completed successfully"
