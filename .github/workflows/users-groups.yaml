# name: OpenVPN User & Group Management via SSH

# on:
#   workflow_dispatch:
#     inputs:
#       users:
#         description: 'Comma-separated VPN usernames'
#         required: true
#         default: 'alice'
#       groups:
#         description: 'Comma-separated Linux groups'
#         required: true
#         default: 'vpn-users'

# jobs:
#   manage-vpn-access:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout repo
#         uses: actions/checkout@v3

#       - name: Configure AWS CLI
#         uses: aws-actions/configure-aws-credentials@v2
#         with:
#           aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
#           aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#           aws-region: ${{ secrets.AWS_REGION }}

#       - name: Parse users
#         id: parse_users
#         run: |
#           echo "users=${{ github.event.inputs.users }}" >> "$GITHUB_OUTPUT"
        
        

#       - name: Parse groups
#         id: parse_groups
#         run: |
#           echo "groups=${{ github.event.inputs.groups }}" >> "$GITHUB_OUTPUT"
        

#       - name: Get EC2 public IPs
#         id: get_ips
#         run: |
#           ASG_NAME="dev-demo-asg"

#           INSTANCE_IDS=$(aws autoscaling describe-auto-scaling-groups \
#             --auto-scaling-group-names $ASG_NAME \
#             --query "AutoScalingGroups[0].Instances[].InstanceId" \
#             --output text)

#           PUBLIC_IPS=""
#           for ID in $INSTANCE_IDS; do
#             IP=$(aws ec2 describe-instances \
#               --instance-ids $ID \
#               --query "Reservations[0].Instances[0].PublicIpAddress" \
#               --output text)
#             PUBLIC_IPS="$PUBLIC_IPS $IP"
#           done

#           echo "ips=$PUBLIC_IPS" >> $GITHUB_OUTPUT

#       - name: Manage users & groups
#         uses: appleboy/ssh-action@v0.1.8
#         with:
#           host: ${{ steps.get_ips.outputs.ips }}
#           username: ubuntu
#           key: ${{ secrets.OPENVPN_SSH_KEY }}
#           script: |
#             USERS="${{ steps.parse_users.outputs.users }}"
#             GROUPS="${{ steps.parse_groups.outputs.groups }}"

#             # Create groups if not exist
#             for GROUP in $GROUPS; do
#               if getent group "$GROUP" >/dev/null; then
#                 echo "Group $GROUP already exists"
#               else
#                 echo "Creating group $GROUP"
#                 sudo groupadd "$GROUP"
#               fi
#             done

#             # Create users and add to groups
#             for USER in $USERS; do
#               if id "$USER" >/dev/null 2>&1; then
#                 echo "User $USER already exists"
#               else
#                 echo "Creating user $USER"
#                 sudo useradd -m "$USER"
#               fi

#               for GROUP in $GROUPS; do
#                 echo "Adding $USER to group $GROUP"
#                 sudo usermod -aG "$GROUP" "$USER"
#               done

#               # Create OpenVPN user
#               echo "Creating OpenVPN user for $USER"
#               sudo /usr/local/bin/add-vpn-user.sh "$USER"
#             done
name: OpenVPN User & Group Management

on:
  workflow_dispatch:
    inputs:
      action:
        description: "Action to perform"
        required: true
        default: "create_user"
        options:
          - create_user
          - delete_user
          - create_group
          - delete_group
      users:
        description: "Comma-separated VPN usernames (required for create_user/delete_user)"
        required: false
        default: ""
      groups:
        description: "Comma-separated OpenVPN groups (required for create_group/delete_group or add user to group)"
        required: false
        default: ""

jobs:
  manage-vpn:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repo (optional)
      - name: Checkout repo
        uses: actions/checkout@v3

      # 2️⃣ Configure AWS CLI (optional, for ASG)
      - name: Configure AWS CLI
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 3️⃣ Get EC2 public IPs from ASG (or use a static IP)
      - name: Get EC2 public IPs
        id: get_ips
        run: |
          ASG_NAME="dev-demo-asg"
          INSTANCE_IDS=$(aws autoscaling describe-auto-scaling-groups \
            --auto-scaling-group-names $ASG_NAME \
            --query "AutoScalingGroups[0].Instances[].InstanceId" \
            --output text)

          PUBLIC_IPS=""
          for ID in $INSTANCE_IDS; do
            IP=$(aws ec2 describe-instances \
              --instance-ids $ID \
              --query "Reservations[0].Instances[0].PublicIpAddress" \
              --output text)
            PUBLIC_IPS="$PUBLIC_IPS $IP"
          done

          # Remove extra spaces and convert to newline-separated
          echo "ips=$(echo $PUBLIC_IPS | tr ' ' '\n')" >> $GITHUB_OUTPUT
          echo "Found EC2 IPs: $PUBLIC_IPS"

      # 4️⃣ Manage OpenVPN via SSH
      - name: OpenVPN User & Group Management via SSH
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ steps.get_ips.outputs.ips }}
          username: ubuntu
          key: ${{ secrets.OPENVPN_SSH_KEY }}
          script: |
            set -e
            ACTION="${{ github.event.inputs.action }}"
            USERS="${{ github.event.inputs.users }}"
            GROUPS="${{ github.event.inputs.groups }}"

            CERT_DIR="/etc/openvpn/easy-rsa/pki/issued"
            BASE_DIR="/etc/openvpn/groups"

            echo "Starting OpenVPN management action: $ACTION"

            # -----------------------
            # Create Group
            # -----------------------
            if [ "$ACTION" == "create_group" ]; then
              for GROUP in $(echo "$GROUPS" | tr ',' ' '); do
                if [ ! -d "$BASE_DIR/$GROUP" ]; then
                  echo "Creating OpenVPN group: $GROUP"
                  sudo mkdir -p "$BASE_DIR/$GROUP"
                  sudo chmod 750 "$BASE_DIR/$GROUP"
                else
                  echo "Group $GROUP already exists"
                fi
              done
            fi

            # -----------------------
            # Delete Group
            # -----------------------
            if [ "$ACTION" == "delete_group" ]; then
              for GROUP in $(echo "$GROUPS" | tr ',' ' '); do
                if [ -d "$BASE_DIR/$GROUP" ]; then
                  echo "Deleting OpenVPN group: $GROUP"
                  sudo rm -rf "$BASE_DIR/$GROUP"
                else
                  echo "Group $GROUP does not exist"
                fi
              done
            fi

            # -----------------------
            # Create User
            # -----------------------
            if [ "$ACTION" == "create_user" ]; then
              for USER in $(echo "$USERS" | tr ',' ' '); do
                if [ ! -f "$CERT_DIR/$USER.crt" ]; then
                  echo "Certificate for user $USER not found. Skipping..."
                  continue
                fi

                for GROUP in $(echo "$GROUPS" | tr ',' ' '); do
                  if [ ! -d "$BASE_DIR/$GROUP" ]; then
                    echo "Group $GROUP does not exist, creating..."
                    sudo mkdir -p "$BASE_DIR/$GROUP"
                    sudo chmod 750 "$BASE_DIR/$GROUP"
                  fi
                  echo "Adding user $USER to OpenVPN group $GROUP"
                  sudo cp "$CERT_DIR/$USER.crt" "$BASE_DIR/$GROUP/"
                  sudo chown root:root "$BASE_DIR/$GROUP/$USER.crt"
                  sudo chmod 640 "$BASE_DIR/$GROUP/$USER.crt"
                done
              done
            fi

            # -----------------------
            # Delete User
            # -----------------------
            if [ "$ACTION" == "delete_user" ]; then
              for USER in $(echo "$USERS" | tr ',' ' '); do
                echo "Deleting user $USER from all OpenVPN groups"
                for GROUP_DIR in "$BASE_DIR"/*; do
                  if [ -f "$GROUP_DIR/$USER.crt" ]; then
                    echo "Removing $USER from $(basename $GROUP_DIR)"
                    sudo rm -f "$GROUP_DIR/$USER.crt"
                  fi
                done
              done
            fi

            echo "✅ OpenVPN management action completed: $ACTION"



